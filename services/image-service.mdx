---
title: Image Service
description: "Convert and optimize images for AI processing. Supports HEIC, JPEG, PNG, and WebP formats."
---

## Overview

The **Image Service** is the first step in the Entropi pipeline. It converts mobile screenshot formats (especially iOS HEIC) to an AI-friendly format and optimizes them for processing.

**File**: `app/services/image_service.py`

## Function

<ParamField body="prepare_image_for_ocr" type="async function">
  Converts any image format to base64-encoded JPEG optimized for OCR processing.
</ParamField>

```python
async def prepare_image_for_ocr(file_bytes: bytes, mime_type: str) -> str
```

<ParamField body="file_bytes" type="bytes" required>
  Raw image file bytes
</ParamField>
<ParamField body="mime_type" type="string" required>
  MIME type (e.g., "image/heic", "image/jpeg")
</ParamField>

**Returns**: Base64-encoded JPEG string (without data URI prefix)

## Supported Formats

<CardGroup cols={2}>
  <Card title="HEIC" icon="mobile-screen">
    iOS screenshots (primary use case)
  </Card>
  <Card title="JPEG" icon="image">
    Standard JPEG images
  </Card>
  <Card title="PNG" icon="image">
    PNG images
  </Card>
  <Card title="WebP" icon="image">
    WebP format
  </Card>
</CardGroup>

## Features

<AccordionGroup>
  <Accordion title="✅ HEIC Conversion">
    Automatically detects and converts HEIC files to JPEG using `pillow-heif` library.
  </Accordion>

  <Accordion title="✅ Smart Resizing">
    Resizes images to a maximum of 2048x2048px while maintaining aspect ratio. Uses high-quality LANCZOS resampling.
  </Accordion>

  <Accordion title="✅ Quality Optimization">
    Converts all images to RGB color space and saves as JPEG with 95% quality for optimal balance between size and quality.
  </Accordion>

  <Accordion title="✅ Base64 Encoding">
    Encodes the final JPEG as base64 string for easy transmission to AI APIs.
  </Accordion>
</AccordionGroup>

## Implementation Details

```python
import base64
import io
import pillow_heif
from PIL import Image

async def prepare_image_for_ocr(file_bytes: bytes, mime_type: str) -> str:
    # Handle HEIC format
    if mime_type == "image/heic":
        heif_file = pillow_heif.read_heif(file_bytes)
        image = Image.frombytes(
            mode=heif_file.mode,
            size=heif_file.size,
            data=heif_file.data,
            decoder_name="raw",
        )
    else:
        image = Image.open(io.BytesIO(file_bytes))

    # Resize if needed (max 2048x2048)
    max_size = (2048, 2048)
    image.thumbnail(max_size, Image.LANCZOS)

    # Convert to RGB and save as JPEG
    output = io.BytesIO()
    image.convert("RGB").save(output, format="JPEG", quality=95)

    # Encode to base64
    jpeg_bytes = output.getvalue()
    base64_string = base64.b64encode(jpeg_bytes).decode("utf-8")

    return base64_string
```

## Usage Example

```python
from app.services.image_service import prepare_image_for_ocr

# In your FastAPI route
async def upload_screenshot(file: UploadFile):
    # Read file bytes
    image_bytes = await file.read()
    mime_type = file.content_type or "image/jpeg"
    
    # Convert to base64
    base64_image = await prepare_image_for_ocr(image_bytes, mime_type)
    
    # Now ready for OCR service
    # ocr_data = await analyze_product_screenshot(base64_image)
```

## Performance

<CardGroup cols={2}>
  <Card title="Average Time" icon="clock">
    ~200ms per image
  </Card>
  <Card title="Success Rate" icon="check-circle">
    100% (tested on 8+ formats)
  </Card>
  <Card title="Output Size" icon="file">
    ~240-340KB base64
  </Card>
  <Card title="Max Input Size" icon="file">
    Up to 10MB supported
  </Card>
</CardGroup>

## Dependencies

```txt
pillow>=10.0.0
pillow-heif>=0.13.0
```

Install with:
```bash
pip install pillow pillow-heif
```

## Error Handling

The service will raise exceptions if:

<Warning>
  - Invalid image format (not supported)
  - Corrupted image file
  - Memory issues with very large images
</Warning>

In the pipeline, these errors result in HTTP 422 responses.

## Output Format

The service returns a **plain base64 string** (not a data URI). To use it with AI APIs, you'll need to add the prefix:

```python
base64_image = await prepare_image_for_ocr(image_bytes, mime_type)
data_uri = f"data:image/jpeg;base64,{base64_image}"
```

<Tip>
  The OCR service automatically adds the data URI prefix, so you can pass the base64 string directly.
</Tip>

## Next Steps

- Learn about the [OCR Service](/services/ocr-service) that uses this output
- Check the [Architecture](/architecture) to see how services connect

